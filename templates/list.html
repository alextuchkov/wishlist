{% extends 'base.html' %}
<title>{% block title %}{{ title }}{% endblock %}</title>
{% block content %}

<div class="content">
    
    <h1>{{ list.name }}</h1>
    <p><b>Опис:</b> {{ list.description }}</p>

    <div class="row">
        <div class="column">
            <p><b>До коли:</b> {{ list.deadline}}</p>
        </div>
        
        <!-- Follow unfollow logic -->
        {% if current_user.is_authenticated %}
        <div class="column">
            <form method="post" action="{{ url_for('toggle_follow') }}">
                <input type="hidden" name="list_id" value="{{ list.id }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="button float-right">
                    {% if list in followed_lists %}
                        Перестати Слідкувати
                    {% else %}
                        Слідкувати
                    {% endif %}
                </button>
            </form>
        </div>
        {% endif %}
      </div>


{% for item in list_items %}
<form id="form-{{ item.id }}" method="post">
    <div class="list-item{% if item.is_booked %}-booked{% endif %}{% if item.sharer_1 or item.sharer_2 %}-shared{% endif %}">
        
        <h3>{{ item.item_name }}</h3>
          


        <p>{{ item.item_description }}</p>
        <p><b>Посилання:</b> {{ item.url }}</p>
        <p><b>Ціна:</b> {{ item.price }} грн.</p>
        <input type="hidden" id="csrf_token" name="csrf_token" value="{{ csrf_token() }}">

        {% if current_user.is_authenticated %}
     

            {% if item.is_booked %}
            <p>This item is booked</p>
            {% endif %}
            {% if item.is_shared %}
            <p>This item is shared</p>
            {% endif %}
    
            
            <!-- Case 1 - where i can book it on my own -->
            {% if not item.is_booked %}
            <button type="button" class="button book-button" data-item-id="{{ item.id }}" data-ref-id="{{ list.id }}">Куплю це сам</button>
            {% endif %}
            
            {% if item.is_booked and item.booked_by == current_user.id %}
                <button type="button" class="button book-button" data-item-id="{{ item.id }}" data-ref-id="{{ list.id }}">Передумав, не куплю</button>
            {% endif %}
    
            <!-- Case 2 - splitting -->
            {% if not item.sharer_1 and not item.is_booked %}
            <button type="button" class="button split-button" data-item-id="{{ item.id }}" data-ref-id="{{ list.id }}">Можу розділити</button>
            {% endif %}

            {% if item.sharer_1 and item.sharer_1 != current_user.id and not item.sharer_2 and not item.is_booked %}
                <button type="button" class="button split-button" data-item-id="{{ item.id }}" data-ref-id="{{ list.id }}">Доєднатись до спліта</button>
            {% endif %}

            <!-- Case 3 - unsplitting -->
            {% if item.sharer_1 == current_user.id %}
                <button type="button" class="button split-button" data-item-id="{{ item.id }}" data-ref-id="{{ list.id }}">Передумав ділити</button>
            {% endif %}

            {% if item.sharer_2 == current_user.id %}
            <button type="button" class="button split-button" data-item-id="{{ item.id }}" data-ref-id="{{ list.id }}">Передумав ділити</button>
            {% endif %}



            <a class="button" href="{{ url_for('listitem', id=item.id) }}">Подивитись</a>
        {% endif %}

    </div>
</form>
{% endfor %}

<script>
    var csrfToken = document.getElementById('csrf_token').value;
</script>






</div>


{% endblock %}